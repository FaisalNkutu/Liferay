AUI().add("liferay-category-admin",function(a){var c=a.Component.create({NAME:"assetcategoryadmin",EXTENDS:a.Base,constructor:function(){c.superclass.constructor.call(this)},prototype:{initializer:function(g){var k=this;var j=a.one(k._categoryContainerSelector);k.portletId=g;k._container=a.one(".vocabulary-container");a.all(".vocabulary-close").on("click",function(){k._closeEditSection()});a.all(".vocabulary-save-category-properties").on("click",function(){k._saveCategoryProperties()});k._portletMessageContainer=a.Node.create('<div class="aui-helper-hidden lfr-message-response" id="vocabulary-messages" />');k._categoryMessageContainer=a.Node.create('<div class="aui-helper-hidden lfr-message-response" id="vocabulary-category-messages" />');k._container.placeBefore(k._portletMessageContainer);j.placeBefore(k._categoryMessageContainer);var f=a.all(".vocabulary-buttons");var i=a.all(".vocabulary-toolbar");var d=a.one(".add-category-layer");var l=a.one(".add-vocabulary-layer");k._toolbarCategoryPanel=new a.OverlayContextPanel({align:{points:["tr","br"]},bodyContent:d,trigger:".add-category-button"}).render();k._vocabularyCategoryPanel=new a.OverlayContextPanel({align:{points:["tr","br"]},bodyContent:l,trigger:".add-vocabulary-button"}).render();k._vocabularyCategoryPanel.after("visibleChange",function(m){if(m.newVal){k._showToolBarVocabularySection()}});k._toolbarCategoryPanel.after("visibleChange",function(m){if(m.newVal){k._showToolBarCategorySection()}});a.one(".permissions-categories-button").on("click",function(){var o=k._selectedCategoryName;var n=k._selectedCategoryId;if(o&&n){var m=k._createPermissionURL("com.liferay.portlet.asset.model.AssetCategory",o,n);submitForm(document.hrefFm,m.toString())}else{k._showToolBarCategorySection()}});a.one(".permissions-vocabulary-button").on("click",function(){var o=k._selectedVocabularyName;var m=k._selectedVocabularyId;if(o&&m){var n=k._createPermissionURL("com.liferay.portlet.asset.model.AssetVocabulary",o,m);submitForm(document.hrefFm,n.toString())}else{k._showToolBarVocabularySection()}});a.one("#vocabulary-select-search").on("change",function(n){var m=a.one("#vocabulary-search-input");if(m){m.focus()}k._reloadSearch()});var h=function(){var p=d.one(".vocabulary-category-name");var o=d.one(".vocabulary-select-list");var n=(p&&p.val())||"";var m=(o&&o.val())||"";k._hideAllMessages();k._addCategory(n,m)};var e=function(){var m=l.one(".vocabulary-name");var n=(m&&m.val())||"";k._hideAllMessages();k._addVocabulary(n)};a.one("input.category-save-button").on("click",h);a.one("input.vocabulary-save-button").on("click",e);a.all(".vocabulary-actions input").on("keyup",function(n){if(n.keyCode==13){var m=n.currentTarget;if(m.hasClass("vocabulary-category-name")){h()}else{if(m.hasClass("vocabulary-name")){e()}}n.halt()}});a.one("input.vocabulary-delete-categories-button").on("click",function(){if(confirm(Liferay.Language.get("are-you-sure-you-want-to-delete-this-category"))){k._deleteCategory(k._selectedCategoryId,function(n){var m=n.exception;if(!m){k._closeEditSection();k._hideToolbarSections();k._displayVocabularyCategories(k._selectedVocabularyId)}else{if(m.indexOf("auth.PrincipalException")>-1){k._sendMessage("error",Liferay.Language.get("you-do-not-have-permission-to-access-the-requested-resource"))}}})}});a.one("input.vocabulary-delete-list-button").on("click",function(){if(confirm(Liferay.Language.get("are-you-sure-you-want-to-delete-this-list"))){k._deleteVocabulary(k._selectedVocabularyId,function(n){var m=n.exception;if(!m){k._closeEditSection();k._hideToolbarSections();k._loadData()}else{if(m.indexOf("auth.PrincipalException")>-1){k._sendMessage("error",Liferay.Language.get("you-do-not-have-permission-to-access-the-requested-resource"))}}})}});a.all(".close-panel").on("click",function(){k._hideToolbarSections()});a.all(".aui-overlay input[type=text]").on("keyup",function(n){var m=27;var o=n.keyCode;if(o==m){k._hideToolbarSections()}});k._loadData();k.after("drop:hit",k._afterDragDrop);k.after("drop:enter",k._afterDragEnter);k.after("drop:exit",k._afterDragExit)},_afterDragDrop:function(i){var e=this;var k=i.drag.get("node");var g=i.drop.get("node");var h=a.Widget.getByNode(k);var d=g.attr("data-vocabularyid");var f=e._getCategoryId(h);var j=e._getCategoryName(h);e._merge(f,j,0,d);e._selectVocabulary(d);g.removeClass("active-area")},_afterDragEnter:function(f){var d=this;var e=f.drop.get("node");e.addClass("active-area")},_afterDragExit:function(f){var d=this;var e=f.target.get("node");e.removeClass("active-area")},_createPermissionURL:function(e,g,h){var d=this;var f=Liferay.PortletURL.createPermissionURL(d.portletId,e,g,h);return f},_displayVocabularyCategoriesImpl:function(f,k){var d=this;var e=[];var j=a.one(d._categoryContainerSelector);var h=a.Node.create('<div class="vocabulary-treeview-container" id="vocabularyTreeContainer"></div>');j.empty();j.append(h);if(d.treeView){d.treeView.destroy()}d.treeView=new b({boundingBox:h,on:{dropAppend:function(q){var m=q.tree;var n=d._getCategoryId(m.dragNode);var r=d._getCategoryName(m.dragNode);var o=d._getCategoryId(m.dropNode);var p=d._getCategoryName(m.dropNode);var l=d._selectedVocabularyId;d._merge(n,r,o,l)},dropInsert:function(r){var n=r.tree;var m=n.dropNode.get("parentNode");var o=d._getCategoryId(n.dragNode);var s=d._getCategoryName(n.dragNode);var p=d._getCategoryId(m);var q=d._getCategoryName(m);var l=d._selectedVocabularyId;d._merge(o,s,p,l)}},type:"normal"}).render();d._buildCategoryTreeview(f,0);d._reloadSearch();var g=a.one(d._vocabularyContainerSelector);var i=g.all("li");i.unplug(a.Plugin.Drop);i.plug(a.Plugin.Drop,{bubbleTargets:[d,d.treeView]});if(k){k()}},_displayList:function(g){var d=this;var e=[];var f=a.one(d._vocabularyContainerSelector);d._showLoading(".vocabulary-categories, .vocabulary-list");e.push("<ul>");d._getVocabularies(function(n){a.each(n,function(r,i,s){e.push("<li");e.push(' class="vocabulary-category results-row');if(i==0){e.push(" selected ")}e.push('" data-vocabulary="');e.push(r.name);e.push('" data-vocabularyId="');e.push(r.vocabularyId);e.push('"><span><a href="javascript:;">');e.push(r.name);e.push("</a></span>");e.push("</li>")});e.push("</ul>");f.html(e.join(""));var j=a.one(d._vocabularyItemSelector);var m=d._getVocabularyName(j);var k=d._getVocabularyId(j);d._selectedVocabularyName=m;d._selectedVocabularyId=k;d._feedVocabularySelect(n,k);var p=f.all("li");p.on("mousedown",function(r){var i=d._getVocabularyId(r.currentTarget);d._selectVocabulary(i)});var q={eventType:"dblclick",on:{contentTextChange:function(u){if(!u.initial){var t=u.target;var s=u.newVal;var r=d._selectedVocabularyId;var i=this.get("node").ancestor("li");i.setAttribute("data-vocabulary",u.newVal);d._updateVocabulary(r,s,function(w){var v=w.exception;if(v){u.newVal=u.prevVal;t._syncContentText(u);t.set("contentText",u.newVal,{initial:true});if(v.indexOf("auth.PrincipalException")>-1){d._sendMessage("error",Liferay.Language.get("you-do-not-have-permission-to-access-the-requested-resource"))}else{if(v.indexOf("VocabularyNameException")>-1){d._sendMessage("error",Liferay.Language.get("one-of-your-fields-contains-invalid-characters"))}}}else{d._displayList(function(){var x=d._selectVocabulary(w.vocabularyId);d._displayVocabularyCategories(d._selectedVocabularyId)})}})}}}};var h=a.all(".vocabulary-list li span a");var o=h.size();for(var l=0;l<o;l++){q.node=h.item(l);new a.Editable(q)}if(g){g()}})},_displayCategoryProperties:function(e){var d=this;d._getCategoryProperties(e,function(h){if(!h.length){h=[{key:"",value:""}]}var g=h.length;var f=a.all("div.vocabulary-property-row").size();if(f>g){return}a.each(h,function(l,k,m){var i=a.all("div.vocabulary-property-row");var n=i.size()-1;var j=i.item(n);d._addCategoryProperty(j,l.key,l.value)})})},_displayVocabularyCategories:function(e,g){var d=this;var f=a.one("#vocabulary-category-messages");if(f){f.hide()}d._getVocabularyCategories(e,function(h){d._displayVocabularyCategoriesImpl(h,g)})},_addCategory:function(g,e,j){var d=this;var h=d._getPermissionsEnabled("category","community");var i=d._getPermissionsEnabled("category","guest");var f={};f[themeDisplay.getDefaultLanguageId()]=g;Liferay.Service.Asset.AssetCategory.addCategory({parentCategoryId:0,titleMap:a.JSON.stringify(f),vocabularyId:e,properties:[],serviceContext:a.JSON.stringify({communityPermissions:h,guestPermissions:i,scopeGroupId:themeDisplay.getParentGroupId()})},function(m){var l=m.exception;if(!l&&m.categoryId){d._sendMessage("success",Liferay.Language.get("your-request-processed-successfully"));d._selectVocabulary(e);d._displayVocabularyCategories(d._selectedVocabularyId,function(){d._hideSection(".vocabulary-edit")});d._resetActionValues();d._hideToolbarSections();if(j){j(g,e)}}else{var k="";if(l.indexOf("DuplicateCategoryException")>-1){k="that-category-already-exists"}else{if((l.indexOf("CategoryNameException")>-1)||(l.indexOf("AssetCategoryException")>-1)){k="one-of-your-fields-contains-invalid-characters"}else{if(l.indexOf("NoSuchVocabularyException")>-1){k="that-vocabulary-does-not-exist"}else{if(l.indexOf("auth.PrincipalException")>-1){k="you-do-not-have-permission-to-access-the-requested-resource"}}}}if(k){d._sendMessage("error",Liferay.Language.get(k))}}})},_addCategoryProperty:function(k,g,j){var d=this;var f=a.one("div.vocabulary-property-row");if(f){var e=f.clone();var i=e.one(".category-property-key");var h=e.one(".category-property-value");if(i){i.val(g)}if(h){h.val(j)}k.placeAfter(e);e.show();if(!g&&!j){e.one("input").focus()}d._attachCategoryPropertyIconEvents(e)}},_addVocabulary:function(e,i){var d=this;var g=d._getPermissionsEnabled("vocabulary","community");var h=d._getPermissionsEnabled("vocabulary","guest");var f={};f[themeDisplay.getDefaultLanguageId()]=e;Liferay.Service.Asset.AssetVocabulary.addVocabulary({title:a.JSON.stringify(f),description:"",settings:"",serviceContext:a.JSON.stringify({communityPermissions:g,guestPermissions:h,scopeGroupId:themeDisplay.getParentGroupId()})},function(l){var k=l.exception;if(!l.exception){d._sendMessage("success",Liferay.Language.get("your-request-processed-successfully"));d._displayList(function(){var m=d._selectVocabulary(l.vocabularyId);d._displayVocabularyCategories(d._selectedVocabularyId);if(m){var n=m.get("region").top;a.one(d._vocabularyContainerSelector).set("scrollTop",n)}});d._resetActionValues();if(i){i(vocabulary)}}else{var j="";if(k.indexOf("DuplicateVocabularyException")>-1){j="that-vocabulary-already-exists"}else{if(k.indexOf("VocabularyNameException")>-1){j="one-of-your-fields-contains-invalid-characters"}else{if(k.indexOf("NoSuchVocabularyException")>-1){j="that-parent-vocabulary-does-not-exist"}else{if(k.indexOf("auth.PrincipalException")>-1){j="you-do-not-have-permission-to-access-the-requested-resource"}}}}if(j){d._sendMessage("error",Liferay.Language.get(j))}}})},_alternateRows:function(){var d=this;var f=a.all(d._categoryContainerSelector);var e=f.all("li");e.removeClass("alt");e.odd().addClass("alt")},_attachCategoryPropertyIconEvents:function(g){var d=this;var e=g.one(".add-category-property");var f=g.one(".delete-category-property");if(e){e.on("click",function(){d._addCategoryProperty(g,"","")})}if(f){f.on("click",function(){d._removeCategoryProperty(g)})}},_buildCategoryTreeview:function(e,g){var d=this;var f=d._filterCategory(e,g);a.each(f,function(k,i,n){var m=k.categoryId;var l=d._filterCategory(e,m).length;var j=new a.TreeNode({alwaysShowHitArea:false,id:"categoryNode"+k.categoryId,label:k.name,leaf:false,on:{select:function(p){var s=p.target.get("id");var q=s.replace("categoryNode","");var r=a.one(".vocabulary-edit");d._selectCategory(q);d._showSection(r)}}});var o="categoryNode"+g;var h=d.treeView.getNodeById(o)||d.treeView;h.appendChild(j);if(l){d._buildCategoryTreeview(e,m)}});return f.length},_buildCategoryProperties:function(){var d=this;var e=[];a.all(".vocabulary-property-row").each(function(i,h,k){if(!i.hasClass("aui-helper-hidden")){var j=i.one("input.category-property-key");var f=i.one("input.category-property-value");if(j&&f){var g=[j.val(),":",f.val(),","].join("");e.push(g)}}});return e.join("")},_closeEditSection:function(){var d=this;d._hideSection(".vocabulary-edit");a.all(d._categoryContainerCellsSelector).setStyle("width","auto")},_deleteCategory:function(e,f){var d=this;Liferay.Service.Asset.AssetCategory.deleteCategory({categoryId:e},f)},_deleteVocabulary:function(e,f){var d=this;Liferay.Service.Asset.AssetVocabulary.deleteVocabulary({vocabularyId:e},f)},_feedVocabularySelect:function(h,g){var e=this;var d=a.one("select.vocabulary-select-list");if(d){var f=[];a.each(h,function(k,i,l){var j=(k.vocabularyId==g);f.push("<option");f.push(j?" selected ":"");f.push(' value="');f.push(k.vocabularyId);f.push('">');f.push(k.name);f.push("</option>")});d.empty().append(f.join(""))}},_filterCategory:function(e,f){var d=this;return a.Array.filter(e,function(h,g,i){return(h.parentCategoryId==f)})},_getCategory:function(e){var d=this;return a.Widget.getByNode("#categoryNode"+e)},_getCategoryId:function(e){var d=this;var g=e.get("id")||"";var f=g.replace("categoryNode","");if(a.Lang.isGuid(f)){f=""}return f},_getCategoryName:function(e){var d=this;return e.get("label")},_getParentCategoryId:function(f){var e=this;var d=f.get("parentNode");return e._getCategoryId(d)},_getPermissionsEnabled:function(h,g){var d=this;var e=[];var i=a.one("."+h+"-permissions-actions");var f=i.all("[name$="+g+"Permissions]");f.each(function(k,j,l){if(k.get("checked")){e.push(k.val())}});return e.join(",")},_getCategoryProperties:function(e,f){var d=this;Liferay.Service.Asset.AssetCategoryProperty.getCategoryProperties({categoryId:e},f)},_getVocabularies:function(e){var d=this;Liferay.Service.Asset.AssetVocabulary.getGroupVocabularies({groupId:themeDisplay.getParentGroupId()},e)},_getVocabulary:function(e){var d=this;return a.one('li[data-vocabularyId="'+e+'"]')},_getVocabularyCategories:function(e,f){var d=this;d._showLoading(d._categoryContainerSelector);Liferay.Service.Asset.AssetCategory.getVocabularyCategories({vocabularyId:e,start:-1,end:-1,obc:null},f)},_getVocabularyId:function(e){var d=this;return a.one(e).attr("data-vocabularyId")},_getVocabularyName:function(e){var d=this;return a.one(e).attr("data-vocabulary")},_hideAllMessages:function(){var d=this;d._container.one(".lfr-message-response").hide()},_hideLoading:function(e){var d=this;d._container.one("div.loading-animation").remove()},_hideSection:function(g){var e=this;var f=a.one(g);if(f){var d=f.get("parentNode");if(d){d.hide()}}},_hideToolbarSections:function(){var d=this;d._toolbarCategoryPanel.hide();d._vocabularyCategoryPanel.hide()},_loadData:function(){var d=this;d._closeEditSection();d._displayList(function(){d._displayVocabularyCategories(d._selectedVocabularyId)})},_merge:function(f,i,g,e){var d=this;var h=d._buildCategoryProperties();e=e||d._selectedVocabularyId;d._updateCategory(f,e,g,i,h)},_reloadSearch:function(){var d=this;var f={input:"#vocabulary-search-input"};var i=a.one("#vocabulary-select-search");var g=(i&&i.val())||"";var e=a.one("#vocabulary-search-input");var h=a.all(d._vocabularyItemSelector);if(/vocabularies/.test(g)){a.mix(f,{data:function(j){return j.one("a").html()},nodes:d._vocabularyItemSelector})}else{a.mix(f,{after:{search:function(k){var j=k.liveSearch.results;a.each(j,function(o,m,p){var l=a.Widget.getByNode(o.node);var n=l.get("boundingBox").hasClass("aui-helper-hidden");if(!n){l.eachParent(function(q){q.get("boundingBox").show()})}})}},data:function(j){return j.one(".aui-tree-label").html()},nodes:d._categoryItemSelector})}if(d.liveSearch){d.liveSearch.destroy()}d.liveSearch=new a.LiveSearch(f)},_removeCategoryProperty:function(e){var d=this;if(a.all("div.vocabulary-property-row").size()>2){e.remove()}},_resetActionValues:function(){var d=this;a.all(".vocabulary-actions input[type=text]").val("");d._vocabularyCategoryPanel.hide()},_saveCategoryProperties:function(){var e=this;var i=e._selectedCategoryId;var j=a.one("input.category-name");var h=(j&&j.val())||e._selectedCategoryName;var g=e._selectedParentCategoryId;var f=e._buildCategoryProperties();var d=e._selectedVocabularyId;e._updateCategory(i,d,g,h,f);e._displayVocabularyCategories(d)},_selectCurrentVocabulary:function(f){var d=this;var e=a.one('select.vocabulary-select-list option[value="'+f+'"]');if(e){e.set("selected",true)}},_selectCategory:function(j){var d=this;var g=d._getCategory(j);var j=d._getCategoryId(g);var i=d._getCategoryName(g);var h=d._getParentCategoryId(g);d._selectedCategoryId=j;d._selectedCategoryName=i;d._selectedParentCategoryId=h||0;if(!j){return g}var f=a.all("div.vocabulary-property-row");var k=a.one(".vocabulary-edit");var e=k.one("input.category-name");if(f.size()>1){f.each(function(m,l,n){if(l>0){m.remove()}})}if(e){e.val(i)}d._displayCategoryProperties(j);d._selectedCategory=g;return g},_selectVocabulary:function(e){var d=this;var g=d._getVocabulary(e);if(g){var f=d._getVocabularyName(g);if(g.hasClass("selected")){return g}d._hideAllMessages();d._selectedVocabularyName=f;d._selectedVocabularyId=e;d._selectCurrentVocabulary(e);d._unselectAllVocabularies();d._closeEditSection();g.addClass("selected");d._displayVocabularyCategories(d._selectedVocabularyId)}return g},_sendMessage:function(f,g){var d=this;var e=d._portletMessageContainer;var h="portlet-msg-"+f;clearTimeout(d._messageTimeout);e.removeClass("portlet-msg-error portlet-msg-success");e.addClass(h);e.html(g);e.show();d._messageTimeout=setTimeout(function(){e.hide();d._toolbarCategoryPanel.refreshAlign();d._vocabularyCategoryPanel.refreshAlign()},7000)},_showLoading:function(e){var d=this;a.all(e).html('<div class="loading-animation" />')},_showSection:function(g){var e=this;var f=a.one(g);if(f){var d=f.get("parentNode");if(d){d.show();f.one("input").focus();a.all(e._categoryContainerCellsSelector).setStyle("width","33%")}}},_showToolBarCategorySection:function(){var d=this;var f=d._toolbarCategoryPanel;if(!d._selectedVocabularyName){d._resetActionValues();f.hide();d._sendMessage("info",Liferay.Language.get("you-must-first-add-a-vocabulary"));d._showToolBarVocabularySection();return}f.refreshAlign();d._vocabularyCategoryPanel.hide();var e=f.get("contentBox").one(".vocabulary-category-name");Liferay.Util.focusFormField(e)},_showToolBarVocabularySection:function(){var d=this;var e=d._vocabularyCategoryPanel;e.refreshAlign();d._toolbarCategoryPanel.hide();var f=e.get("contentBox").one(".vocabulary-name");Liferay.Util.focusFormField(f)},_unselectAllVocabularies:function(){var d=this;a.all(d._vocabularyItemSelector).removeClass("selected")},_updateCategory:function(j,e,i,f,h,k){var d=this;var g={};g[themeDisplay.getDefaultLanguageId()]=f;Liferay.Service.Asset.AssetCategory.updateCategory({categoryId:j,parentCategoryId:i,titleMap:a.JSON.stringify(g),vocabularyId:e,properties:h,serviceContext:null},function(n){var m=n.exception;if(!m){d._selectedCategory.set("label",f);d._closeEditSection()}else{var l="";if(m.indexOf("AssetCategoryNameException")>-1){l=Liferay.Language.get("please-enter-a-valid-category-name")}else{if(m.indexOf("DuplicateCategoryException")>-1){l=Liferay.Language.get("there-is-another-category-with-the-same-name-and-the-same-parent")}else{if(m.indexOf("NoSuchVocabularyException")>-1){l=Liferay.Language.get("that-vocabulary-does-not-exist")}else{if(m.indexOf("NoSuchCategoryException")>-1){l=Liferay.Language.get("that-parent-category-does-not-exist")}else{if(m.indexOf("auth.PrincipalException")>-1){l=Liferay.Language.get("you-do-not-have-permission-to-access-the-requested-resource")}else{if(m.indexOf("Exception")>-1){l=Liferay.Language.get("one-of-your-fields-contains-invalid-characters")}}}}}}if(l){d._sendMessage("error",Liferay.Language.get(l))}}if(k){k(n)}})},_updateVocabulary:function(d,e,g){var f={};f[themeDisplay.getDefaultLanguageId()]=e;Liferay.Service.Asset.AssetVocabulary.updateVocabulary({vocabularyId:d,title:a.JSON.stringify(f),description:"",settings:"",serviceContext:a.JSON.stringify({scopeGroupId:themeDisplay.getParentGroupId()})},g)},_categoryItemSelector:".vocabulary-categories .aui-tree-node",_categoryContainerCellsSelector:".portlet-categories-admin .vocabulary-content td",_categoryContainerSelector:".vocabulary-categories",_selectedCategoryName:null,_selectedVocabulary:null,_selectedVocabularyId:null,_selectedVocabularyName:null,_vocabularyItemSelector:".vocabulary-list li",_vocabularyContainerSelector:".vocabulary-list"}});var b=a.Component.create({NAME:"VocabularyTree",EXTENDS:a.TreeViewDD,prototype:{_updateNodeState:function(f){var d=this;var e=f.drop.get("node");if(e&&e.hasClass("vocabulary-category")){d._appendState(e)}else{b.superclass._updateNodeState.apply(d,arguments)}}}});Liferay.Portlet.AssetCategoryAdmin=c},"",{requires:["aui-editable","aui-live-search","aui-overlay-context-panel","aui-tree-view","dd","json","liferay-portlet-url"]});